<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Конструктор справочника</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      padding: 20px;
      max-width: 960px;
      margin: auto;
      background-color: #f9f9f9;
      line-height: 1.5;
      color: #575757;
    }

    .form-section {
      border: 1px solid #ddd;
      padding: 20px;
      margin-bottom: 24px;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .form-section h2 {
      margin-top: 0;
      color: #E94277;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .grid {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 12px 20px;
      align-items: center;
    }

    label {
      font-weight: 600;
      white-space: nowrap;
      display: flex;
      align-items: center;
    }

    input, select {
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
      max-width: 300px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: 'Montserrat', sans-serif;
      transition: border-color 0.3s;
    }

    input.error, select.error {
      border-color: #BA0000;
    }

    input:disabled {
      background-color: #f0f0f0;
      color: #999;
      cursor: not-allowed;
    }

    .options-group {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
    }

    .options-group legend {
      font-weight: 600;
      padding: 0 8px;
      color: #575757;
    }

    .options-vertical {
      padding: 0;
      margin: 0;
    }

    .options-vertical label {
      display: flex;
      align-items: center;
      margin: 0;
      padding: 0;
      gap: 0;
    }

    .options-vertical input[type="checkbox"] {
      margin: 0;
      padding: 0;
      width: auto;
      height: auto;
      position: relative;
      left: -4px;
      transform: scale(1.1);
    }

    .options-vertical label > span:first-of-type {
      margin-left: 0;
      padding-left: 0;
    }

    button {
      margin-top: 16px;
      padding: 10px 20px;
      cursor: pointer;
      background: #E94277;
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      transition: background 0.2s;
      font-family: 'Montserrat', sans-serif;
    }

    button:hover {
      background: #7a1f60;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #aaa;
    }

    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: left;
    }

    th {
      background: #f2f2f2;
      font-weight: 600;
    }

    .checkbox-col {
      text-align: center;
      width: 40px;
    }

    .actions-under-table {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }

    .centered-button {
      display: flex;
      justify-content: center;
      margin: 30px 0;
    }

    .code-output-block {
      position: relative;
      margin-top: 20px;
    }

    .code-actions {
      position: absolute;
      right: 0;
      top: 0;
      margin: 8px;
      display: flex;
      gap: 5px;
    }

    .copy-btn, .clear-btn {
      padding: 4px 10px;
      font-size: 12px;
      color: white;
      border: none;
      border-radius: 4px;
      font-family: 'Montserrat', sans-serif;
      cursor: pointer;
    }

    .copy-btn {
      background: #E94277;
    }

    .copy-btn:hover {
      background: #7a1f60;
    }

    .clear-btn {
      background: #575757;
    }

    .clear-btn:hover {
      background: #3d3d3d;
    }

    textarea {
      width: 100%;
      height: 250px;
      margin-top: 0;
      box-sizing: border-box;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.4;
      background: #f8f8f8;
      font-family: 'Montserrat', sans-serif;
    }

    .tooltip {
      position: relative;
      display: inline-block;
      margin-left: 5px;
      cursor: help;
    }

    .tooltip .fa-circle-info {
      color: #575757;
      font-size: 16px;
      transition: color 0.2s;
    }

    .tooltip:hover .fa-circle-info {
      color: #333;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 13px;
      font-weight: normal;
      white-space: normal;
      font-family: 'Montserrat', sans-serif;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    fieldset {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin: 15px 0;
      display: block;
    }

    legend {
      padding: 0 10px;
      font-weight: 600;
      color: #575757;
    }

    .required:after {
      content: " *";
      color: #E94277;
    }

    /* Стили для уведомлений */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #E94277;
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      font-weight: 500;
      display: flex;
      align-items: flex-start; /* Изменено с center на flex-start */
      gap: 10px;
      white-space: pre-line;
      max-width: 80%;
      text-align: left;
    }

    .notification.error {
      background-color: #575757;
      align-items: flex-start; /* Добавлено для ошибок */
    }

    .notification-icon {
      font-size: 16px;
      margin-top: 2px; /* Добавлено для выравнивания иконки */
	  margin-left: -10px;
      flex-shrink: 0; /* Запрещаем сжатие иконки */
    }
    
    .notification span {
      display: inline-block;
      text-align: left;
    }
	
    .notification.show {
      opacity: 1;
    }

    /* Стиль для чекбокса "выбрать все" */
    .select-all-checkbox {
      margin-right: 5px;
    }

    /* Модальное окно подтверждения */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      max-width: 400px;
      width: 100%;
    }

    .modal-title {
      margin-top: 0;
      color: #E94277;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
    }

    .modal-btn-primary {
      background-color: #E94277;
      color: white;
    }

    .modal-btn-secondary {
      background-color: #575757;
      color: white;
    }
  </style>
</head>
<body>
  <h1 style="color: #000000;">Конструктор справочника</h1>

  <div class="notification" id="notification">
    <i class="fas fa-check-circle notification-icon"></i>
    <span></span>
  </div>
  <div class="notification" id="copyNotification">
    <i class="fas fa-check-circle notification-icon"></i>
    <span>Текст скопирован</span>
  </div>
  <div class="notification error" id="errorNotification">
    <i class="fas fa-exclamation-circle notification-icon"></i>
    <span id="errorMessage"></span>
  </div>

  <!-- Модальное окно подтверждения -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal">
      <h3 class="modal-title">Подтверждение</h3>
      <p>Вы уверены, что хотите удалить выбранные столбцы?</p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" id="cancelDelete">Отмена</button>
        <button class="modal-btn modal-btn-primary" id="confirmDelete">Удалить</button>
      </div>
    </div>
  </div>

  <div class="form-section">
    <h2>Основные настройки справочника</h2>
    <div class="grid">
      <label for="dictName" class="required">Системное имя:</label>
      <div>
        <input type="text" id="dictName" value="ExampleDictionary" maxlength="300" />
        <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltiptext">Должно начинаться с буквы, содержать только латиницу, цифры и подчёркивания. Например: UserData, Report_2023</span></span>
      </div>

      <label for="dictDisplayName" class="required">Отображаемое имя:</label>
      <div>
        <input type="text" id="dictDisplayName" value="Название справочника" maxlength="300" />
        <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltiptext">Название, которое будут видеть пользователи в системе. Может содержать любые символы.</span></span>
      </div>
    </div>

    <fieldset>
      <legend style="color: #E94277;">Дополнительные опции</legend>
      <div class="options-vertical">
        <label><input type="checkbox" id="withImport" checked> <span>Импорт данных</span> <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltiptext">Добавляет возможность импорта данных в справочник из Excel файлов</span></span></label>
        <label><input type="checkbox" id="withClear"> <span>Очистка справочника</span> <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltiptext">Добавляет возможность полной очистки данных справочника</span></span></label>
      </div>
    </fieldset>
  </div>

  <div class="form-section">
    <h2>Добавление столбцов</h2>
    <div class="grid">
      <label for="name" class="required">Системное имя:</label>
      <div>
        <input type="text" id="name" maxlength="300" placeholder="Например: Address, PhoneNumber" />
        <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltiptext">Имя поля в коде. Только латиница, цифры и подчёркивания. Например: FullName, BirthDate</span></span>
      </div>

      <label for="displayName" class="required">Отображаемое имя:</label>
      <div>
        <input type="text" id="displayName" maxlength="300" placeholder="Например: Адрес, Номер телефона" />
        <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltiptext">Название столбца, которое увидят пользователи</span></span>
      </div>

      <label for="type" class="required">Тип данных:</label>
      <div>
        <select id="type">
          <option value="StringField">Строка (StringField)</option>
          <option value="TextField">Текст (TextField)</option>
          <option value="DateField">Дата (DateField)</option>
          <option value="DatetimeField">Дата и время (DatetimeField)</option>
          <option value="BoolField">Логическое (BoolField)</option>
          <option value="IntField">Целое число (IntField)</option>
          <option value="DecimalField">Число (DecimalField)</option>
        </select>
        <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltiptext">Тип данных для столбца. Выберите соответствующий типу хранимых данных</span></span>
      </div>

      <label for="length">Максимальная длина:</label>
      <div>
        <input type="number" id="length" placeholder="1 - 20000" />
        <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltiptext">Максимальное количество символов для строковых полей</span></span>
      </div>

      <label for="colSpan">Ширина (colSpan):</label>
      <div>
        <input type="number" id="colSpan" value="2" min="1" max="12" placeholder="1 - 12"/>
        <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltiptext">Ширина столбца в интерфейсе (1-12, где 12 - полная ширина)</span></span>
      </div>
    </div>
    <button id="add-column-btn">Добавить столбец</button>
  </div>

  <h2 style="color: #E94277;">Список столбцов</h2>
  <table id="columns-table">
    <thead>
      <tr>
        <th class="checkbox-col"><input type="checkbox" id="select-all" class="select-all-checkbox"></th>
        <th>Системное имя</th>
        <th>Отображаемое имя</th>
        <th>Тип</th>
        <th>Длина</th>
        <th>Ширина</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="actions-under-table">
    <button id="delete-columns-btn" disabled>Удалить выбранные</button>
  </div>

  <div class="centered-button">
    <button onclick="generateCode()">Сгенерировать код</button>
  </div>

  <div class="code-output-block">
    <textarea id="code-output" readonly placeholder="Здесь появится сгенерированный код справочника..."></textarea>
    <div class="code-actions">
      <button class="copy-btn" id="copy-btn">Копировать</button>
      <button class="clear-btn" onclick="document.getElementById('code-output').value=''">Очистить</button>
    </div>
  </div>

  <script>
    const columns = [];

    const typeLabels = {
      StringField: "Строка",
      TextField: "Текст",
      DateField: "Дата",
      DatetimeField: "Дата и время",
      BoolField: "Логическое",
      IntField: "Целое число",
      DecimalField: "Число"
    };

    // Обработчик изменения типа данных
    document.getElementById("type").addEventListener("change", function() {
      const lengthField = document.getElementById("length");
      if (this.value === "StringField") {
        lengthField.disabled = false;
        lengthField.placeholder = "1 - 20000";
      } else {
        lengthField.disabled = true;
        lengthField.value = "";
        lengthField.placeholder = "Только для типа Строка (StringField)";
      }
    });

    // Функция для показа уведомления
    function showNotification(elementId, message = '', duration = 3500) {
      const notification = document.getElementById(elementId);
      
      // Скрываем все уведомления перед показом нового
      document.querySelectorAll('.notification.show').forEach(el => {
        el.classList.remove('show');
      });
      
      if (elementId === 'errorNotification') {
        const errorMessageElement = document.getElementById('errorMessage');
        errorMessageElement.innerHTML = message.replace(/\n/g, '<br>');
        
        if (message.includes("Системное имя должно:") || message.includes("Системное имя справочника должно:")) {
          duration = 5000;
        }
      } else if (message) {
        // Для других уведомлений устанавливаем текст, если он передан
        notification.querySelector('span').textContent = message;
      }
      
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    // Функция для сброса ошибок валидации
    function resetValidationErrors() {
      document.querySelectorAll('input.error, select.error').forEach(el => {
        el.classList.remove('error');
      });
    }

    // Обработчик для кнопки "Добавить столбец"
    document.getElementById("add-column-btn").addEventListener("click", function() {
      const success = addColumn();
      if (success) {
        showNotification('notification', 'Столбец добавлен');
      }
    });

    // Обработчик для кнопки "Копировать"
    document.getElementById("copy-btn").addEventListener("click", function() {
      const codeOutput = document.getElementById("code-output");
      codeOutput.select();
      document.execCommand('copy');
      showNotification('copyNotification', 'Текст скопирован в буфер обмена');
    });

    // Обработчик для "Выбрать все"
    document.getElementById("select-all").addEventListener("change", function() {
      const checkboxes = document.querySelectorAll('#columns-table tbody input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      updateDeleteButtonState();
    });

    // Обработчики для модального окна подтверждения
    document.getElementById("delete-columns-btn").addEventListener("click", function() {
      document.getElementById("confirmModal").classList.add("show");
    });

    document.getElementById("cancelDelete").addEventListener("click", function() {
      document.getElementById("confirmModal").classList.remove("show");
    });

    document.getElementById("confirmDelete").addEventListener("click", function() {
      document.getElementById("confirmModal").classList.remove("show");
      deleteSelectedColumns();
    });

    function isValidSystemName(name) {
      return /^[a-zA-Z][a-zA-Z0-9_]*$/.test(name) && !/^\d+$/.test(name) && !name.includes(" ");
    }

    function addColumn() {
      resetValidationErrors();
      
      const name = document.getElementById("name").value.trim();
      const displayName = document.getElementById("displayName").value.trim();
      const type = document.getElementById("type").value;
      const length = document.getElementById("length").value;
      const colSpan = parseInt(document.getElementById("colSpan").value);

      let hasError = false;

      if (!name) {
        document.getElementById("name").classList.add('error');
        hasError = true;
      }

      if (!displayName) {
        document.getElementById("displayName").classList.add('error');
        hasError = true;
      }

      if (!type) {
        document.getElementById("type").classList.add('error');
        hasError = true;
      }

      if (hasError) {
        showNotification('errorNotification', 'Заполните все обязательные поля (помечены *)');
        return false;
      }

      if (!isValidSystemName(name)) {
        document.getElementById("name").classList.add('error');
        showNotification('errorNotification', 'Системное имя должно:\n• Начинаться с буквы\n• Содержать только латиницу, цифры и подчёркивания\n• Не быть числом\n• Не содержать пробелы');
        return false;
      }

      if (columns.some(col => col.name === name)) {
        document.getElementById("name").classList.add('error');
        showNotification('errorNotification', 'Системное имя столбца должно быть уникальным');
        return false;
      }

      if (type === "StringField" && (isNaN(length) || length <= 0 || length > 20000)) {
        document.getElementById("length").classList.add('error');
        showNotification('errorNotification', 'Для StringField длина должна быть от 1 до 20000 символов');
        return false;
      }

      if (isNaN(colSpan) || colSpan <= 0 || colSpan > 12) {
        document.getElementById("colSpan").classList.add('error');
        showNotification('errorNotification', 'Ширина (colSpan) должна быть числом от 1 до 12');
        return false;
      }

      if (name.length > 300 || displayName.length > 300) {
        showNotification('errorNotification', 'Слишком длинное имя — максимум 300 символов');
        return false;
      }

      columns.push({ 
        name, 
        displayName, 
        type, 
        length: type === "StringField" ? parseInt(length) : null, 
        colSpan 
      });
      renderColumns();

      document.getElementById("name").value = "";
      document.getElementById("displayName").value = "";
      document.getElementById("length").value = "";
      
      return true;
    }

    function renderColumns() {
      const tbody = document.querySelector("#columns-table tbody");
      tbody.innerHTML = "";
      columns.forEach((col, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="checkbox-col"><input type="checkbox" data-index="${index}" onchange="updateDeleteButtonState()"></td>
          <td>${col.name}</td>
          <td>${col.displayName}</td>
          <td>${typeLabels[col.type]} (${col.type})</td>
          <td style="padding-left: 8.5px; text-align: center">${col.type === "StringField" ? col.length : "—"}</td>
          <td>${col.colSpan}</td>
        `;
        tbody.appendChild(row);
      });

      updateDeleteButtonState();
    }

    function updateDeleteButtonState() {
      const checkboxes = document.querySelectorAll('#columns-table tbody input[type="checkbox"]');
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
      document.getElementById("delete-columns-btn").disabled = !anyChecked;
      
      // Обновляем состояние "Выбрать все"
      const selectAll = document.getElementById("select-all");
      selectAll.checked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
    }

    function deleteSelectedColumns() {
      const checkboxes = document.querySelectorAll('#columns-table tbody input[type="checkbox"]');
      const toDelete = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => parseInt(cb.dataset.index));

      if (toDelete.length === 0) return;

      for (let i = toDelete.length - 1; i >= 0; i--) {
        columns.splice(toDelete[i], 1);
      }
      renderColumns();
      document.getElementById("select-all").checked = false;
      showNotification('notification', 'Выбранные столбцы удалены');
    }

    function generateCode() {
      resetValidationErrors();
      
      const dictName = document.getElementById("dictName").value.trim();
      const dictDisplayName = document.getElementById("dictDisplayName").value.trim();

      if (!dictName) {
        document.getElementById("dictName").classList.add('error');
        showNotification('errorNotification', 'Введите системное имя справочника');
        return;
      }

      if (!dictDisplayName) {
        document.getElementById("dictDisplayName").classList.add('error');
        showNotification('errorNotification', 'Введите отображаемое имя справочника');
        return;
      }

      if (!isValidSystemName(dictName)) {
        document.getElementById("dictName").classList.add('error');
        showNotification('errorNotification', 'Системное имя справочника должно:\n• Начинаться с буквы\n• Содержать только латиницу, цифры и подчёркивания\n• Не быть числом\n• Не содержать пробелы');
        return;
      }

      if (dictName.length > 300 || dictDisplayName.length > 300) {
        showNotification('errorNotification', 'Слишком длинное имя справочника — максимум 300 символов');
        return;
      }

      if (columns.length === 0) {
        showNotification('errorNotification', 'Добавьте хотя бы один столбец');
        return;
      }

      const imports = new Set(['import org.zenframework.z8.base.table.Table;']);
      const withImport = document.getElementById("withImport").checked;
      const withClear = document.getElementById("withClear").checked;

      if (withImport) imports.add('import pro.doczilla.dictionary.importFile.CsvDictionaryImportAction;');
      if (withClear) imports.add('import pro.doczilla.dictionary.action.ClearAction;');

      const fieldsCode = columns.map(col => {
        imports.add(`import org.zenframework.z8.base.table.value.${col.type};`);
        let fieldCode = `
[name "${col.name}"]
[displayName "${col.displayName}"]
public ${col.type} ${col.name};`;
        
        // Добавляем длину только для StringField
        if (col.type === "StringField") {
          fieldCode += `
${col.name}.length = ${col.length};`;
        }
        
        fieldCode += `
${col.name}.colSpan = ${col.colSpan};`;
        
        return fieldCode;
      });

      const fieldNames = columns.map(c => c.name).join(', ');

      const actionsBlock = (() => {
        const actions = [];
        if (withClear) actions.push('clearAction');
        if (withImport) actions.push('importAction');
        if (actions.length === 0) return '';
        return `
${withImport ? 'CsvDictionaryImportAction importAction;' : ''}
${withClear ? 'ClearAction clearAction;' : ''}
actions = {${actions.join(', ')}};`;
      })();

      const result = `
${[...imports].sort().join('\n')}

[generatable]
[dictionary]
[request true]
[name "${dictName}"]
[displayName "${dictDisplayName}"]
public class ${dictName} extends Table {

${fieldsCode.join('\n\n')}

columns = {${fieldNames}};
controls = {${fieldNames}};${actionsBlock ? '\n' + actionsBlock : ''}
}
`;

      document.getElementById("code-output").value = result.trim();
      showNotification('notification', 'Код успешно сгенерирован');
    }

    // Инициализация при загрузке
    document.addEventListener("DOMContentLoaded", function() {
      const typeSelect = document.getElementById("type");
      const lengthField = document.getElementById("length");
      
      if (typeSelect.value !== "StringField") {
        lengthField.disabled = true;
        lengthField.placeholder = "Только для StringField";
      }
    });
  </script>
</body>
</html>
